<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CCTV Designer Tool</title>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body { margin:0; font-family:Arial,sans-serif; background:#f2f2f2; }
  #toolbar {
    position:fixed; left:0; top:0; bottom:0; width:200px;
    background:#2c3e50; color:white; padding:15px; overflow-y:auto;
  }
  #toolbar h2 { font-size:18px; color:#fff; margin-top:0; }
  #toolbar input, #toolbar button {
    width:100%; margin:5px 0; padding:8px;
    border:none; border-radius:4px;
  }
  #toolbar input { font-size:14px; }
  #toolbar button { background:#34495e; color:white; cursor:pointer; }
  #toolbar button:hover { background:#1abc9c; }
  #map { position:absolute; top:0; left:200px; right:0; bottom:0; }
  .rotation-slider {
    width:100%; margin-top:10px;
  }
</style>
</head>
<body>

<div id="toolbar">
  <h2>üõ†Ô∏è CCTV Designer</h2>
  <input id="address" type="text" placeholder="Enter address and press Enter" onkeydown="if(event.key==='Enter') geocodeAddress()" />
  <button onclick="addCamera()">üì∑ Add Camera</button>
  <input id="rotation" type="range" min="0" max="360" step="1" value="0" class="rotation-slider" onchange="rotateSelectedCamera(this.value)" />
  <button onclick="deleteSelected()">üóëÔ∏è Delete Selected</button>
  <button onclick="exportDesign()">üíæ Export Design</button>
</div>

<div id="map"></div>

<script>
// ===== Initialize map =====
let map = L.map('map').setView([51.505, -0.09], 18);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 22,
}).addTo(map);

let cameras = [];
let selectedCamera = null;

// ===== Camera icon =====
const cameraIcon = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/2857/2857390.png',
  iconSize: [32, 32],
  iconAnchor: [16, 16],
});

// ===== Add camera =====
function addCamera() {
  const center = map.getCenter();
  const cam = {
    marker: L.marker(center, { icon: cameraIcon, draggable: true }).addTo(map),
    fov: 60, range: 60, angle: 0, cone: null
  };

  drawCameraCone(cam);

  cam.marker.on('click', () => selectCamera(cam));
  cam.marker.on('drag', () => drawCameraCone(cam));
  cameras.push(cam);
  selectCamera(cam);
}

// ===== Draw camera cone =====
function drawCameraCone(cam) {
  if (cam.cone) map.removeLayer(cam.cone);

  const pos = cam.marker.getLatLng();
  const R = cam.range / 100000; // Convert range to degrees roughly
  const halfAngle = cam.fov / 2;
  const points = [pos];

  for (let i = -halfAngle; i <= halfAngle; i += 5) {
    const angleRad = (cam.angle + i) * Math.PI / 180;
    const lat = pos.lat + R * Math.cos(angleRad);
    const lng = pos.lng + R * Math.sin(angleRad);
    points.push([lat, lng]);
  }

  cam.cone = L.polygon(points, { color: 'red', opacity: 0.6, fillOpacity: 0.2 }).addTo(map);
}

// ===== Select camera =====
function selectCamera(cam) {
  selectedCamera = cam;
  document.getElementById('rotation').value = cam.angle;
  cameras.forEach(c => {
    if (c.cone) c.cone.setStyle({ color: c === cam ? 'blue' : 'red' });
  });
}

// ===== Rotate camera =====
function rotateSelectedCamera(angle) {
  if (!selectedCamera) return;
  selectedCamera.angle = parseFloat(angle);
  drawCameraCone(selectedCamera);
}

// ===== Delete camera =====
function deleteSelected() {
  if (!selectedCamera) return;
  map.removeLayer(selectedCamera.marker);
  map.removeLayer(selectedCamera.cone);
  cameras = cameras.filter(c => c !== selectedCamera);
  selectedCamera = null;
}

// ===== Export Design =====
function exportDesign() {
  const data = cameras.map(c => ({
    latlng: c.marker.getLatLng(),
    angle: c.angle, fov: c.fov, range: c.range
  }));
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cctv_design.json';
  a.click();
}

// ===== Geocode address to map center =====
async function geocodeAddress() {
  const addr = document.getElementById('address').value.trim();
  if (!addr) return;
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
  const data = await res.json();
  if (data.length > 0) {
    const { lat, lon } = data[0];
    map.setView([parseFloat(lat), parseFloat(lon)], 19);
  } else {
    alert('Address not found.');
  }
}

</script>
</body>
</html>
